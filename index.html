<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éºµåŒ…åº—å·¥æ™‚çµ±è¨ˆç³»çµ± v19</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --bg-color: #f4f7f6;
        }
        body { font-family: -apple-system, "Segoe UI", Roboto, sans-serif; padding: 10px; background: var(--bg-color); line-height: 1.4; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h2, h3 { margin-top: 0; color: #333; }
        
        /* è¼¸å…¥å€ä½ˆå±€ */
        .control-panel { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        select, button { padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; }
        .btn-add { background: var(--primary-color); color: white; border: none; font-weight: bold; flex-grow: 1; cursor: pointer; }
        
        /* æ—¥æ›†ä½ˆå±€ */
        #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 10px; }
        .day-box { border: 1px solid #f0f0f0; min-height: 70px; padding: 4px; background: #fff; border-radius: 4px; }
        .day-num { font-weight: bold; font-size: 12px; color: #999; border-bottom: 1px solid #f9f9f9; margin-bottom: 4px; }
        
        /* å“¡å·¥é¡è‰²æ¨™ç±¤ */
        .tag { font-size: 10px; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; line-height: 1.2; word-break: break-all; }
        .user-0 { background: #fff9c4; border-left: 3px solid #fbc02d; color: #7f6000; } /* ç«™èµ·ä¾† */
        .user-1 { background: #e1f5fe; border-left: 3px solid #03a9f4; color: #01579b; } /* å·¥è®€ç”ŸA */
        .user-2 { background: #f3e5f5; border-left: 3px solid #9c27b0; color: #4a148c; } /* å·¥è®€ç”ŸB */
        .user-default { background: #eeeeee; border-left: 3px solid #9e9e9e; }

        /* çµ±è¨ˆèˆ‡æ¸…å–®å€ */
        .stats-box { background: #e3f2fd; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; border-left: 4px solid var(--secondary-color); }
        .record-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .btn-del { background: #ff5252; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        
        /* åŒæ­¥æŒ‰éˆ• */
        .sync-section { margin-top: 15px; }
        .btn-sync { background: var(--secondary-color); color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold; box-shadow: 0 4px 10px rgba(33,150,243,0.3); }
        .status-bar { font-size: 13px; color: #666; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="status-bar" id="statusMsg">ğŸ”„ æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™...</div>

    <div class="card">
        <h3>â• æ–°å¢å·¥æ™‚</h3>
        <div class="control-panel">
            <select id="monthSelect" onchange="initCalendar()"></select>
            <select id="nameInput">
                <option value="ç«™èµ·ä¾†">ç«™èµ·ä¾†</option>
                <option value="å·¥è®€ç”ŸA">ä½‘å»·</option>
                <option value="å·¥è®€ç”ŸB">å­çˆ</option>
            </select>
            <select id="dayInput"></select>
            <div style="display:flex; width:100%; gap:5px; align-items:center;">
                <select id="startTime" style="flex:1"></select>
                <span>è‡³</span>
                <select id="endTime" style="flex:1"></select>
            </div>
            <button class="btn-add" onclick="addRecord()">ç¢ºèªæ–°å¢</button>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“… ç­è¡¨é è¦½</h3>
        <div id="calendar"></div>
    </div>

    <div class="card">
        <h3>ğŸ“‹ æœ¬æœˆçµ±è¨ˆèˆ‡æ¸…å–®</h3>
        <div id="statsArea" class="stats-box">ç¸½æ™‚æ•¸è¨ˆç®—ä¸­...</div>
        <div id="recordList"></div>
        
        <div class="sync-section">
            <button class="btn-sync" onclick="syncToCloud()">â˜ï¸ å„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯</button>
        </div>
    </div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwxvdNvCDBPN8Q0BwePsHJRkP5c0o12QNoTTfcomi8eHsOv1EgTEYerG7FpJ5rpO9aSzg/exec"; // è«‹æ›¿æ›æˆä½ çš„ GAS ç¶²å€
    let currentData = [];
    const nameList = ["ç«™èµ·ä¾†", "å·¥è®€ç”ŸA", "å·¥è®€ç”ŸB"];

    // åˆå§‹åŒ–
    function init() {
        const monthSel = document.getElementById('monthSelect');
        const startSel = document.getElementById('startTime');
        const endSel = document.getElementById('endTime');
        
        // ç”Ÿæˆæœˆä»½
        for(let i=-1; i<=1; i++) {
            let d = new Date();
            d.setMonth(d.getMonth() + i);
            let s = d.toISOString().substring(0, 7);
            monthSel.innerHTML += `<option value="${s}">${s}</option>`;
        }
        monthSel.value = new Date().toISOString().substring(0, 7);

        // ç”Ÿæˆæ™‚é–“ (08:00 - 23:30)
        for(let h=8; h<24; h++) {
            ['00', '30'].forEach(m => {
                let t = `${h<10?'0'+h:h}:${m}`;
                startSel.innerHTML += `<option value="${t}">${t}</option>`;
                endSel.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }
        
        initCalendar();
        loadFromCloud();
    }

    function initCalendar() {
        const daySel = document.getElementById('dayInput');
        daySel.innerHTML = "";
        const [y, m] = document.getElementById('monthSelect').value.split('-');
        const days = new Date(y, m, 0).getDate();
        for(let i=1; i<=days; i++) daySel.innerHTML += `<option value="${i}">${i}æ—¥</option>`;
        renderView();
    }

    function addRecord() {
        const record = {
            month: document.getElementById('monthSelect').value,
            name: document.getElementById('nameInput').value,
            day: document.getElementById('dayInput').value,
            start: document.getElementById('startTime').value,
            end: document.getElementById('endTime').value
        };
        currentData.push(record);
        renderView();
    }

    function deleteRecord(index) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
            currentData.splice(index, 1);
            renderView();
        }
    }

    function calculateHours(start, end) {
        const [sH, sM] = start.split(':').map(Number);
        const [eH, eM] = end.split(':').map(Number);
        let diff = (eH + eM/60) - (sH + sM/60);
        return diff > 0 ? diff : 0;
    }

    function renderView() {
        const selectedMonth = document.getElementById('monthSelect').value;
        const calDiv = document.getElementById('calendar');
        const listDiv = document.getElementById('recordList');
        const statsDiv = document.getElementById('statsArea');
        
        calDiv.innerHTML = "";
        listDiv.innerHTML = "";
        
        // 1. è™•ç†çµ±è¨ˆ
        let stats = {};
        nameList.forEach(n => stats[n] = 0);
        
        // 2. ç¹ªè£½æ—¥æ›†
        const [y, m] = selectedMonth.split('-');
        const days = new Date(y, m, 0).getDate();
        
        for(let i=1; i<=days; i++) {
            const dayRecords = currentData.filter(d => d.month === selectedMonth && d.day == i);
            let tagsHtml = dayRecords.map(d => {
                const uIdx = nameList.indexOf(d.name);
                const colorClass = uIdx !== -1 ? `user-${uIdx}` : 'user-default';
                return `<div class="tag ${colorClass}">${d.name}<br>${d.start}-${d.end}</div>`;
            }).join('');
            
            calDiv.innerHTML += `
                <div class="day-box">
                    <div class="day-num">${i}</div>
                    ${tagsHtml}
                </div>`;
        }

        // 3. è™•ç†æ¸…å–®èˆ‡åŠ ç¸½
        const monthRecords = currentData.filter(d => d.month === selectedMonth).sort((a,b)=>a.day-b.day);
        monthRecords.forEach((d, idx) => {
            const h = calculateHours(d.start, d.end);
            stats[d.name] += h;
            listDiv.innerHTML += `
                <div class="record-item">
                    <span><strong>${d.day}æ—¥</strong> ${d.name} <small>(${d.start}-${d.end})</small></span>
                    <button class="btn-del" onclick="deleteRecord(${currentData.indexOf(d)})">åˆªé™¤</button>
                </div>`;
        });

        // 4. é¡¯ç¤ºç¸½æ™‚æ•¸
        let statsHtml = "<strong>ğŸ“Š ç•¶æœˆç¸½æ™‚æ•¸çµ±è¨ˆï¼š</strong><br>";
        for(let name in stats) {
            if(stats[name] > 0) statsHtml += `${name}: ${stats[name].toFixed(1)} å°æ™‚<br>`;
        }
        statsDiv.innerHTML = statsHtml === "<strong>ğŸ“Š ç•¶æœˆç¸½æ™‚æ•¸çµ±è¨ˆï¼š</strong><br>" ? "æœ¬æœˆå°šç„¡ç´€éŒ„" : statsHtml;
    }

    async function loadFromCloud() {
        try {
            const res = await fetch(GAS_URL);
            currentData = await res.json();
            document.getElementById('statusMsg').innerText = "âœ… é›²ç«¯è³‡æ–™è¼‰å…¥æˆåŠŸ";
            renderView();
        } catch(e) {
            document.getElementById('statusMsg').innerText = "âŒ ç„¡æ³•è®€å–é›²ç«¯è³‡æ–™";
        }
    }

    async function syncToCloud() {
        const btn = document.querySelector('.btn-sync');
        btn.disabled = true;
        document.getElementById('statusMsg').innerText = "â³ æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...";
        try {
            await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(currentData)
            });
            document.getElementById('statusMsg').innerText = "âœ… é›²ç«¯åŒæ­¥æˆåŠŸï¼";
            alert("åŒæ­¥æˆåŠŸï¼è³‡æ–™å·²å­˜å…¥è©¦ç®—è¡¨ã€‚");
        } catch(e) {
            document.getElementById('statusMsg').innerText = "âŒ åŒæ­¥å¤±æ•—";
            alert("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦ã€‚");
        } finally {
            btn.disabled = false;
        }
    }

    window.onload = init;
</script>
</body>
</html>