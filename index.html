<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>éºµåŒ…åº—å·¥æ™‚çµ±è¨ˆ - é›²ç«¯åŒæ­¥ç‰ˆ</title>
<style>
    /* CSS éƒ¨åˆ†ä¿æŒä¸è®Š */
    * { box-sizing: border-box; }
    body { font-family: "Microsoft JhengHei", Arial; padding:20px; background: #f8f9fa; }
    select, button, input { margin:2px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
    button { cursor: pointer; background: #fff; }
    button:hover { background: #eee; }
    .row { display:flex; align-items:center; gap:5px; margin-bottom:5px; flex-wrap: wrap; background:#fff; padding:8px; border-radius:8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .hours { font-size: 13px; font-weight: bold; color: #5555aa; min-width: 50px; text-align: center; }
    .summary { margin-top:20px; padding:15px; background:#fff; border-radius: 8px; border: 1px solid #eee; }
    .calendar-container { margin-top: 20px; background: #fff; padding: 10px; border-radius: 8px; }
    .calendar { display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; }
    .weekday { text-align: center; background: #5a9bd4; color: white; padding: 8px; font-size: 13px; border-radius: 4px; }
    .day { border:1px solid #eee; min-height:80px; position:relative; font-size:12px; padding:4px; background:#fff; border-radius: 4px; }
    .date-num { font-weight: bold; color:#999; margin-bottom: 4px; }
    .shift { font-size:10px; padding:2px 4px; margin-top:2px; border-radius:3px; color:#fff; display:block; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
    .shift[data-name="ç«™èµ·ä¾†"] { background: #5a9bd4; }
    .shift[data-name="ä½‘ä½‘"] { background: #70ad47; }
    .shift[data-name="çˆçˆ"] { background: #e06666; }
</style>
</head>
<body>

<h2>ğŸ éºµåŒ…åº—å·¥æ™‚çµ±è¨ˆ <span id="syncStatus" style="font-size:13px; color:blue;">(æº–å‚™ä¸­...)</span></h2>

<div style="margin-bottom: 15px;">
    æœˆä»½ï¼š<select id="monthSelect" onchange="render()"></select>
    <button onclick="addRecord()" style="background: #e3f2fd;">â• æ–°å¢ç´€éŒ„ (åƒ…æœ¬æ©Ÿ)</button>
    <button onclick="syncToCloud()" style="background: #4caf50; color: white; border: none; font-weight: bold; padding: 5px 15px;">ğŸ”„ å„²å­˜ä¸¦åŒæ­¥åˆ°é›²ç«¯</button>
</div>

<div id="records"></div>

<div class="summary">
    <h3>ğŸ“Š æœ¬æœˆçµ±è¨ˆ</h3>
    <div id="summary"></div>
</div>

<div class="calendar-container">
    <h3>ğŸ—“ï¸ æœˆä»½æ—¥æ›†</h3>
    <div class="calendar" style="margin-bottom: 4px;">
        <div class="weekday">æ—¥</div><div class="weekday">ä¸€</div><div class="weekday">äºŒ</div>
        <div class="weekday">ä¸‰</div><div class="weekday">å››</div><div class="weekday">äº”</div><div class="weekday">å…­</div>
    </div>
    <div id="calendar" class="calendar"></div>
</div>

<script>
// è«‹ç¢ºä¿æ­¤è™• URL èˆ‡éƒ¨ç½²ç¶²å€ä¸€è‡´
const GAS_URL = "https://script.google.com/macros/s/AKfycbwxvdNvCDBPN8Q0BwePsHJRkP5c0o12QNoTTfcomi8eHsOv1EgTEYerG7FpJ5rpO9aSzg/exec"; 

let employees = [
    { name: "ç«™èµ·ä¾†", wage: 190 }, 
    { name: "ä½‘ä½‘", wage: 190 }, 
    { name: "çˆçˆ", wage: 190 }
];
let records = [];

// æŠ“å–é›²ç«¯è³‡æ–™
async function fetchFromCloud() {
    const status = document.getElementById("syncStatus");
    status.textContent = "â˜ï¸ æ­£åœ¨æŠ“å–é›²ç«¯è³‡æ–™...";
    try {
        const response = await fetch(GAS_URL);
        records = await response.json();
        status.textContent = "âœ… é›²ç«¯è³‡æ–™å·²è¼‰å…¥";
        localStorage.setItem("workRecords", JSON.stringify(records));
        render();
    } catch (e) {
        status.textContent = "âš ï¸ é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å­˜æª”";
        records = JSON.parse(localStorage.getItem("workRecords")) || [];
        render();
    }
}

// é—œéµä¿®æ”¹ï¼šæ‰‹å‹•åŒæ­¥å‡½å¼
async function syncToCloud() {
    const status = document.getElementById("syncStatus");
    status.textContent = "ğŸš€ åŒæ­¥å‚³è¼¸ä¸­ï¼Œè«‹ç¨å€™...";
    
    try {
        // ç™¼é€ç›®å‰ç•«é¢ä¸Šçš„æ‰€æœ‰ç´€éŒ„
        const response = await fetch(GAS_URL, { 
            method: "POST", 
            body: JSON.stringify(records),
            mode: 'no-cors' // é˜²æ­¢æŸäº›ç€è¦½å™¨çš„ CSP æ””æˆªï¼Œä½†é€™æœƒè®“ä½ æ”¶ä¸åˆ° Success å­—æ¨£
        });
        
        status.textContent = "âœ… é›²ç«¯å­˜æª”æˆåŠŸï¼è³‡æ–™å·²ä¿éšª";
        // é–ƒçˆä¸€ä¸‹ç¶ è‰²æç¤º
        status.style.color = "green";
        setTimeout(() => { status.style.color = "blue"; }, 3000);
    } catch (e) {
        console.error(e);
        status.textContent = "âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
    }
}

// ä¿®æ”¹ saveï¼šç¾åœ¨åªå­˜åˆ°ç€è¦½å™¨ï¼Œä¸é©šå‹•é›²ç«¯
function save() {
    localStorage.setItem("workRecords", JSON.stringify(records));
}

function initMonths() {
    const select = document.getElementById("monthSelect");
    const now = new Date();
    for(let m=1; m<=12; m++){
        let monthStr = `${now.getFullYear()}-${String(m).padStart(2,"0")}`;
        let option = document.createElement("option");
        option.value = monthStr; option.text = monthStr;
        select.appendChild(option);
    }
    select.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
}

function calculateHours(start,end){
    if(!start||!end) return 0;
    let s=parseInt(start.split(":")[0]); let e=parseInt(end.split(":")[0]);
    let diff=e-s; if(diff<0) diff+=24; return diff;
}

function generateDays(selected){ let html=""; for(let i=1;i<=31;i++){ html+=`<option value="${i}" ${i==selected?"selected":""}>${i}æ—¥</option>`;} return html; }
function generateHours(selected){ let html=""; for(let i=0;i<24;i++){ let h=String(i).padStart(2,"0")+":00"; html+=`<option value="${h}" ${h==selected?"selected":""}>${h}</option>`;} return html; }

function addRecord(){
    records.push({ month: document.getElementById("monthSelect").value, name: employees[0].name, day: 1, start: "14:00", end: "17:00" });
    save(); render();
}

// æ›´æ–°èˆ‡åˆªé™¤éƒ½åªæ”¹æœ¬åœ°
function update(index,field,value){ records[index][field]=value; save(); render(); }
function removeRecord(index){ if(confirm("ç¢ºå®šåˆªé™¤?")){ records.splice(index,1); save(); render(); } }

// å¿«æ·éµ
function setMorning(index){ records[index].start="12:00"; records[index].end="17:00"; save(); render(); }
function setAfternoon(index){ records[index].start="14:00"; records[index].end="17:00"; save(); render(); }
function setEvening(index){ records[index].start="17:00"; records[index].end="21:00"; save(); render(); }
function setFullDay(index){ records[index].start="12:00"; records[index].end="21:00"; save(); render(); }

function render(){
    const container=document.getElementById("records");
    const summaryDiv=document.getElementById("summary");
    const calendarDiv=document.getElementById("calendar");
    container.innerHTML=""; summaryDiv.innerHTML=""; calendarDiv.innerHTML="";

    const currentMonth=document.getElementById("monthSelect").value;
    const [year,month]=currentMonth.split("-").map(Number);
    let monthRecords=records.filter(r=>r.month===currentMonth);

    monthRecords.forEach((r,i)=>{
        const globalIndex=records.indexOf(r);
        const hours=calculateHours(r.start,r.end);
        let div=document.createElement("div");
        div.className="row";
        div.innerHTML=`
            <select onchange="update(${globalIndex},'name',this.value)">${employees.map(e=>`<option value="${e.name}" ${e.name===r.name?"selected":""}>${e.name}</option>`).join("")}</select>
            <select onchange="update(${globalIndex},'day',this.value)">${generateDays(r.day)}</select>
            <select onchange="update(${globalIndex},'start',this.value)">${generateHours(r.start)}</select>
            ~
            <select onchange="update(${globalIndex},'end',this.value)">${generateHours(r.end)}</select>
            <span class="hours">â±ï¸ ${hours}h</span>
            <button onclick="setMorning(${globalIndex})">æ—©</button><button onclick="setAfternoon(${globalIndex})">ä¸‹</button>
            <button onclick="setEvening(${globalIndex})">æ™š</button><button onclick="setFullDay(${globalIndex})">å…¨</button>
            <button onclick="removeRecord(${globalIndex})" style="color:red; border-color:#ffcccc;">åˆªé™¤</button>
        `;
        container.appendChild(div);
    });

    employees.forEach(emp=>{
        let totalHours=0;
        monthRecords.filter(r=>r.name===emp.name).forEach(r=>{ totalHours+=calculateHours(r.start,r.end); });
        if(totalHours>0) summaryDiv.innerHTML+=`<strong>${emp.name}</strong>ï¼š${totalHours}h / <span style="color:red">$${(totalHours*emp.wage).toLocaleString()}</span><br>`;
    });

    // æ—¥æ›†ç¹ªè£½é‚è¼¯ä¿æŒä¸è®Š
    const firstDay = new Date(year, month-1, 1).getDay();
    const totalDays = new Date(year, month, 0).getDate();
    let dayCount = 1;
    for(let i=0; i<42; i++){
        let dayDiv=document.createElement("div"); dayDiv.className="day";
        if(i >= firstDay && dayCount <= totalDays){
            dayDiv.innerHTML=`<div class="date-num">${dayCount}</div>`;
            monthRecords.filter(r=>r.day==dayCount).forEach(r=>{
                let span=document.createElement("div"); 
                span.className=`shift`;
                span.setAttribute('data-name', r.name);
                span.textContent=`${r.name} ${r.start}-${r.end}`;
                dayDiv.appendChild(span);
            });
            dayCount++;
        }
        calendarDiv.appendChild(dayDiv);
        if(dayCount > totalDays && i >= (Math.ceil((firstDay + totalDays)/7)*7)-1) break;
    }
}

initMonths();
fetchFromCloud(); 
</script>
</body>
</html>