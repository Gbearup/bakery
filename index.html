<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>éºµåŒ…åº—å·¥æ™‚çµ±è¨ˆ - é›²ç«¯åŒæ­¥ç‰ˆ</title>
<style>
    /* é€™è£¡ä¿ç•™ä½ åŸæœ¬æ¼‚äº®çš„ CSS ä¸¦åšäº†å¾®èª¿ */
    * { box-sizing: border-box; }
    body { font-family: Arial; padding:20px; background: #f8f9fa; }
    select, button, input { margin:2px; padding: 5px; }
    .row { display:flex; align-items:center; gap:5px; margin-bottom:5px; flex-wrap: wrap; background:#fff; padding:5px; border-radius:5px; }
    .hours { font-size: 12px; color: #5555aa; min-width: 50px; text-align: center; }
    .summary { margin-top:20px; padding:10px; background:#f5f5f5; font-size: 12px; }
    
    .calendar { display:grid; grid-template-columns: repeat(7, 1fr); gap:2px; margin-top:10px; }
    .weekday { text-align: center; background: #5a9bd4; color: white; padding: 5px; font-size: 12px; }
    .day { border:1px solid #ccc; min-height:60px; position:relative; font-size:12px; padding:2px; background:#fff; overflow: hidden; }
    .date-num { font-weight: bold; color:#666; margin-bottom: 2px; }
    .shift { font-size:10px; padding:1px 2px; margin-top:2px; border-radius:3px; color:#fff; display:block; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
    .shift.A { background:#5a9bd4; } .shift.B { background:#70ad47; } .shift.C { background:#e06666; }
</style>
</head>
<body>

<h2>ğŸ éºµåŒ…åº—å·¥æ™‚çµ±è¨ˆ <span id="syncStatus" style="font-size:12px; color:blue;">(é›²ç«¯åŒæ­¥ä¸­...)</span></h2>

æœˆä»½ï¼š<select id="monthSelect" onchange="render()"></select>
<button onclick="addRecord()">â• æ–°å¢ç´€éŒ„</button>
<button onclick="syncToCloud()">ğŸ”„ æ‰‹å‹•åŒæ­¥é›²ç«¯</button>

<div id="records"></div>

<div class="summary">
    <h3>ğŸ“Š æœ¬æœˆçµ±è¨ˆ</h3>
    <div id="summary"></div>
</div>

<h3>ğŸ—“ï¸ æœˆä»½æ—¥æ›†</h3>
<div class="calendar">
    <div class="weekday">æ—¥</div><div class="weekday">ä¸€</div><div class="weekday">äºŒ</div>
    <div class="weekday">ä¸‰</div><div class="weekday">å››</div><div class="weekday">äº”</div><div class="weekday">å…­</div>
</div>
<div class="calendar" id="calendar"></div>

<script>
// 1. ã€åœ¨æ­¤è™•è²¼ä¸Šä½ çš„ç¶²å€ã€‘
const GAS_URL = "https://script.google.com/macros/s/AKfycbw_MmIdWFRkcW_nljF71XheYdRUReVCYHRMVaB6c_F7W5q5exyGoUEua2JLEw8IMYD3rQ/exec"; 

let employees = [{ name: "ç«™èµ·ä¾†", wage: 190 }, { name: "ä½‘ä½‘", wage: 190 }, { name: "çˆçˆ", wage: 190 }];
let records = [];

// ====== é›²ç«¯åŠŸèƒ½ ======
async function fetchFromCloud() {
    document.getElementById("syncStatus").textContent = "â˜ï¸ æ­£åœ¨æŠ“å–é›²ç«¯è³‡æ–™...";
    try {
        const response = await fetch(GAS_URL);
        records = await response.json();
        document.getElementById("syncStatus").textContent = "âœ… é›²ç«¯å·²åŒæ­¥";
        render();
    } catch (e) {
        document.getElementById("syncStatus").textContent = "âš ï¸ é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å­˜æª”";
        records = JSON.parse(localStorage.getItem("workRecords")) || [];
        render();
    }
}

async function syncToCloud() {
    document.getElementById("syncStatus").textContent = "ğŸš€ åŒæ­¥ä¸­...";
    try {
        await fetch(GAS_URL, { method: "POST", body: JSON.stringify(records) });
        document.getElementById("syncStatus").textContent = "âœ… åŒbsé›²ç«¯æˆåŠŸ";
    } catch (e) {
        document.getElementById("syncStatus").textContent = "âŒ åŒæ­¥å¤±æ•—";
    }
}

// ====== åŸæœ¬çš„é‚è¼¯ (å·²æ•´åˆ save åˆ°é›²ç«¯) ======
function save() {
    localStorage.setItem("workRecords", JSON.stringify(records));
    syncToCloud(); // æ¯æ¬¡å­˜æª”è‡ªå‹•å‚³åˆ° Google Sheets
}

function initMonths() {
    const select = document.getElementById("monthSelect");
    const now = new Date();
    for(let m=1; m<=12; m++){
        let monthStr = `${now.getFullYear()}-${String(m).padStart(2,"0")}`;
        let option = document.createElement("option");
        option.value = monthStr; option.text = monthStr;
        select.appendChild(option);
    }
    select.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
}

function calculateHours(start,end){
    if(!start||!end) return 0;
    let s=parseInt(start.split(":")[0]); let e=parseInt(end.split(":")[0]);
    let diff=e-s; if(diff<0) diff+=24; return diff;
}

function generateDays(selected){ let html=""; for(let i=1;i<=31;i++){ html+=`<option value="${i}" ${i==selected?"selected":""}>${i}</option>`;} return html; }
function generateHours(selected){ let html=""; for(let i=0;i<24;i++){ let h=String(i).padStart(2,"0")+":00"; html+=`<option value="${h}" ${h==selected?"selected":""}>${h}</option>`;} return html; }

function addRecord(){
    records.push({ month: document.getElementById("monthSelect").value, name: employees[0].name, day: 1, start: "14:00", end: "17:00" });
    save(); render();
}

function update(index,field,value){ records[index][field]=value; save(); render(); }
function removeRecord(index){ if(confirm("ç¢ºå®šåˆªé™¤?")){ records.splice(index,1); save(); render(); } }
function setMorning(index){ records[index].start="12:00"; records[index].end="17:00"; save(); render(); }
function setAfternoon(index){ records[index].start="14:00"; records[index].end="17:00"; save(); render(); }
function setEvening(index){ records[index].start="17:00"; records[index].end="21:00"; save(); render(); }
function setFullDay(index){ records[index].start="12:00"; records[index].end="21:00"; save(); render(); }

function render(){
    const container=document.getElementById("records");
    const summaryDiv=document.getElementById("summary");
    const calendarDiv=document.getElementById("calendar");
    container.innerHTML=""; summaryDiv.innerHTML=""; calendarDiv.innerHTML="";

    const currentMonth=document.getElementById("monthSelect").value;
    const [year,month]=currentMonth.split("-").map(Number);
    let monthRecords=records.filter(r=>r.month===currentMonth);

    monthRecords.forEach((r,i)=>{
        const globalIndex=records.indexOf(r);
        const hours=calculateHours(r.start,r.end);
        let div=document.createElement("div");
        div.className="row";
        div.innerHTML=`
            <select onchange="update(${globalIndex},'name',this.value)">${employees.map(e=>`<option value="${e.name}" ${e.name===r.name?"selected":""}>${e.name}</option>`).join("")}</select>
            <select onchange="update(${globalIndex},'day',this.value)">${generateDays(r.day)}</select>
            <select onchange="update(${globalIndex},'start',this.value)">${generateHours(r.start)}</select>
            <select onchange="update(${globalIndex},'end',this.value)">${generateHours(r.end)}</select>
            <span class="hours">${hours}h</span>
            <button onclick="setMorning(${globalIndex})">æ—©</button><button onclick="setAfternoon(${globalIndex})">ä¸‹</button>
            <button onclick="setEvening(${globalIndex})">æ™š</button><button onclick="setFullDay(${globalIndex})">å…¨</button>
            <button onclick="removeRecord(${globalIndex})" style="color:red">åˆªé™¤</button>
        `;
        container.appendChild(div);
    });

    employees.forEach(emp=>{
        let totalHours=0;
        monthRecords.filter(r=>r.name===emp.name).forEach(r=>{ totalHours+=calculateHours(r.start,r.end); });
        if(totalHours>0) summaryDiv.innerHTML+=`${emp.name}ï¼š${totalHours}h / $${(totalHours*emp.wage).toLocaleString()}<br>`;
    });

    const firstDay = new Date(year, month-1, 1).getDay();
    const totalDays = new Date(year, month, 0).getDate();
    let dayCount = 1;
    for(let i=0; i<42; i++){
        let dayDiv=document.createElement("div"); dayDiv.className="day";
        if(i >= firstDay && dayCount <= totalDays){
            dayDiv.innerHTML=`<div class="date-num">${dayCount}</div>`;
            monthRecords.filter(r=>r.day==dayCount).forEach(r=>{
                let span=document.createElement("div"); span.className=`shift ${r.name}`;
                span.textContent=`${r.name} ${r.start}-${r.end}`;
                dayDiv.appendChild(span);
            });
            dayCount++;
        }
        calendarDiv.appendChild(dayDiv);
    }
}

initMonths();
fetchFromCloud(); // å•Ÿå‹•æ™‚å…ˆæŠ“é›²ç«¯
</script>
</body>
</html>